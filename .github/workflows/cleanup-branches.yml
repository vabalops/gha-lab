name: Cleanup merged branches

on:
  schedule:
    - cron: '0 0 * * *' # every 24 hours (UTC)
  workflow_dispatch: # optional manual trigger

jobs:
  delete-merged-branches:
    runs-on: self-hosted

    permissions:
      contents: write
      pull-requests: read

    steps:
      - name: Delete merged branches
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            const protectedBranches = ['main'];

            const pulls = await github.paginate(
              github.rest.pulls.list,
              {
                owner,
                repo,
                state: 'closed',
                per_page: 100
              }
            );

            for (const pr of pulls) {
              if (!pr.merged) continue;

              const branch = pr.head.ref;

              if (protectedBranches.includes(branch)) {
                core.info(`Skipping protected branch: ${branch}`);
                continue;
              }

              try {
                await github.rest.git.deleteRef({
                  owner,
                  repo,
                  ref: `heads/${branch}`
                });
                core.info(`Deleted branch: ${branch}`);
              } catch (error) {
                core.warning(`Could not delete branch ${branch}: ${error.message}`);
              }
            }
